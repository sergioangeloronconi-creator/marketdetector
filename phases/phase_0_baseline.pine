//@version=6
// FASE 0 — BASELINE (Bull/Bear Market)
// Sempre presente, sempre calcolato, sempre attivo in background
// Priorità: 1 (più bassa)
// Logica ufficiale Q-Mentor: SMA150 come discriminante principale

// Funzione per determinare Bull/Bear Market
// Restituisce: [isBull, isBear, color]
// Logica ufficiale:
// - BULL: SPY > SMA150 (spy_vs_sma150 > 0)
// - BEAR: SPY < SMA150 (spy_vs_sma150 < 0)
// - Se SMA150 non disponibile: usa EMA30 come proxy
// - Se anche EMA30 non disponibile: usa returns
baselinePhase() =>
    // EMA30 (shock/crash/recovery)
    ema30 = ta.ema(close, 30)
    
    // SMA150 (regime primario) - DISCRIMINANTE PRINCIPALE
    sma150 = ta.sma(close, 150)
    
    // Calcolo posizioni relative (percentuali)
    spy_vs_ema30 = na(ema30) ? na : (close - ema30) / ema30
    spy_vs_sma150 = na(sma150) ? na : (close - sma150) / sma150
    
    // Returns per fallback
    returns = ta.change(close) / close[1]
    
    // Classificazione basata su priorità:
    // 1. SMA150 (discriminante principale)
    // 2. EMA30 (proxy durante warm-up period)
    // 3. Returns (fallback)
    // 4. Default: BULL (conservativo)
    
    isBull = false
    isBear = false
    
    if not na(spy_vs_sma150)
        // Classificazione principale basata su SMA150
        if spy_vs_sma150 > 0
            isBull := true
        else if spy_vs_sma150 < 0
            isBear := true
        // spy_vs_sma150 == 0 è NEUTRAL (caso raro)
    else if not na(spy_vs_ema30)
        // Proxy: usa EMA30 durante warm-up period (< 150 barre)
        if spy_vs_ema30 > 0
            isBull := true
        else
            isBear := true
    else if not na(returns)
        // Fallback: usa returns
        if returns > 0
            isBull := true
        else
            isBear := true
    else
        // Default conservativo: BULL
        isBull := true
    
    // Colori: Verde per Bull, Rosso per Bear
    phaseColor = isBull ? color.new(color.green, 80) : isBear ? color.new(color.red, 80) : color.new(color.gray, 90)
    
    [isBull, isBear, phaseColor]
